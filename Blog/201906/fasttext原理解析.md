# fasttext原理解析

##1.特点

fastText方法包含三部分，**模型架构，层次SoftMax和字符级N-gram特征**。 

fastText 也利用了类别（class）不均衡这个事实（一些类别出现次数比其他的更多），通过使用 Huffman 算法建立用于表征类别的树形结构。因此，频繁出现类别的树形结构的深度要比不频繁出现类别的树形结构的深度要小，这也使得进一步的计算效率更高。 

**字符级N-gram特征**的这带来两点好处：

1. 对于低频词生成的词向量效果会更好。因为它们的n-gram可以和其它词共享。

2. 对于训练词库之外的单词，仍然可以构建它们的词向量。我们可以叠加它们的字符级n-gram向量。

fasttext的模型结构跟CBOW的结构很类似，都是多个输入预测中间词的输出概率。**不同的是，**CBOW的输入是目标单词的上下文，fastText的输入是多个单词及其n-gram特征，这些特征用来表示单个文档；CBOW的输入单词被onehot编码过，fastText的输入特征是被embedding过；CBOW的输出是目标词汇，fastText的输出是文档对应的类标。

**于是fastText的核心思想就是：将整篇文档的词及n-gram向量叠加平均得到文档向量，然后使用文档向量做softmax多分类。**这中间涉及到两个技巧：字符级n-gram特征的引入以及分层Softmax分类。



##2.与Word2vec对比

​        word2vec包含两种结构，一种是skip-gram结构，一种是cbow结构，skip-gram结构是利用中间词预测邻近词，cbow模型是利用上下文词预测中间词。 

​        CBOW的隐含层的输出是C个上下文单词向量的加权平均，权重为*W*。接着我们计算输出层的每个节点：

![img](data:image/png;base64,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)

这里![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACUAAAAfCAYAAABgfwTIAAADxElEQVRYR+1XSSi1YRR+rmFFyRhRZChRypiFJEooIWUlMxmTxErKuDGFnZBIhoXChgjZKMmUEhkLxYKtjH/P6f9uxuv7bu7tX/xvvV33+859z/M+55znHLrX19dX/GNL9x+UyogYxRQjfnBwAAcHB7i4uKh0pd7MKFDPz89wdHREQEAAVldXYWVlpd6jCkujQG1ubiI0NBQVFRXo7u6GTqdT4Uq9iVGgOjs7UV1djePjY3h7e6v3ptJSM6iXlxekpqbi/Pwc29vbv84ScRsFigne0dGB/Px8lXfXZqYZFPMpNjYWt7e3sLCw0OZNpfUnUCx37o8OHx8fpcqYTwydKRJcwfwOFB23t7djd3cXWVlZiI+Ph6WlJQ4PD1FZWYmGhgbY29vD1tYWbm5uKu+t3UwP6uHhAdnZ2QgJCcHR0REmJydxdXUFa2tr1NbWoqurC2VlZejp6TFZ2D4xNT8/j+HhYdm5ubkYGRnBxcUF3N3d5TMqKgqZmZlobGw0HyhWk5eXF1JSUuDk5ISgoCAsLy9L+LjKy8vh6emJmpoa7fHQ+At9+Ng6qEFkqqCgAH19fSgsLJTj+DwtLU1kwNfXV6ML7ebvEl0RxtnZWVxfX+ub7dPTk+QaxdKQDCgXI7uKHc/k33x3f38PGxubH1G+A6U4Zy/b2trSH0zWKAMtLS3fHkindXV1Mj2waouLi8HiSU5OxtDQkFyotLQU6+vrcHZ2NgjsE1PBwcGws7PD0tKS6NLNzQ3i4uKwsrIik8F3a25uDmdnZ7i8vBRb7p2dHWncBLyxsSFgFxYWEB4eLsfwOauc+RsYGKg/+h0oimZ9fT2am5sxNjYmid3a2oqSkhIkJSUZvN3U1BQSExMRGRkpmpaXl4e2tjYwFQiQKzo6WkYdJbQElZCQgN7eXvj7+38Nik8Z99HRUQkfw5mTk4OIiAhVMnBycgIfHx+ZHjw8PJCeng4yTxkhAIJVdI4EMLwESC18u77tfd+1G0N0LS4uykjD/sje6Ofnh/HxcWGD7wi6qKhIjlhbW5NNoSZTivTwneaGbAgUkzgjIwN7e3vY398XhinCBFVVVYXBwUFhhXk6MDAgUwZtyKzJQDFE/f39mJmZQUxMjOQQWaAsEFRYWJjMX/zOPT09LbaszrfT668ypbBIcMwVBQBT4S0Tih1zjJX3cS4zCagf1fFvl6Ags2o/jtRmB0XWyOTd3Z3o1enp6aeR2uygWI0UUldXV+kSlIiP/w2ZHdTExISEjI29qanpS/0zOyhWHZehxm52UGqK4A994jTCFgBoKAAAAABJRU5ErkJggg==)是矩阵![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAaCAYAAAA5WTUBAAADJklEQVRIS+1WTSh0YRR+xr8UaczSgrJh4W8hKYRSUySykoXsFAspSowxCzWNFU0WJEzNRpRIRP42VrKw8xMppUgW5Hfm6zl97+1Od+747ma+jVO37r3nfc953uc559xrC4fDYfxns/2C+KvALxOqFOPKxP39PQ4ODtDc3Iy0tDStHeIKore3F9PT09jY2IDT6TQH8fX1Jc6EhASwe202G0KhkDzzen19RUpKirxLTEyUNbznO9r7+7vsoSUlJYHx6OO6kpISPD8/4+rqSmKZyhEMBjEzMyOB1AhhEr/fj9zcXNTX1yMjI0P8vL6/v1FTU4OxsTG57+npwfn5uebPy8uTeC8vL7Db7RgZGcH4+HjEZDLI8fHxgbu7OzQ1NeHs7AyTk5Po6+vTQDGR2+3GxMQECgsLsbm5CYfDgfT0dGGE+0n78fExhoeHhfbMzEwsLy+jvb0dl5eXyM/Pjw2CXjJQW1uLw8ND7OzsyOn1tr29jcbGRlRXV2N/f1+jn2sIhMx4vV5UVlZq23iQm5sbrK6uRkjBBVELUw+CJ2hra9OC0dfS0oK1tbWoIHZ3dzE/P4+lpSUNnKoHl8uF1tZWw0fCtDuIfGpqyqAhk3R1deH29hbFxcU4OTnRTkYWyCBPS/2VfX5+oqCgwFCQP86J0dFReDyeCBAqic/nQ0VFhcRgjahKn52dFcq5T29k4u3tDampqQYpTOWgIxqIubk5XF9fg7QmJydLHp6Srfjw8IC6ujqcnp5GTWTQQPfCVA52xcDAADo7O7GwsICnpyepBRYijTOCxjnAVmXrlZWVRdRPrMR6nykIat/Q0CDFt7e3J8yUlpZKEjWoGOji4kIk6e7ulnVkxar9EwjK0N/fj5WVFW0KkvqjoyNsbW1JAXNYlZeXW80v638EwQ4oKioSECqJvoUHBwelUwKBQMS8sILGFMTj4yNycnIkVkdHh6Hv1TDLysqSKahvSSsAYjJBnalvtCT6gcWC5BhXHy2rAGKCUMVnloSFuri4aDqArIAxlYOfbM7/oaGhiB8QFXx9fR3Z2dmoqqqyki/q2rj+1Jih/QWhmPkDsg3nwvJ4FU8AAAAASUVORK5CYII=)的第j列，最后，将![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAZCAYAAADNAiUZAAACnElEQVRIS+2VvUuyYRTGLz9wCKQho0HBxWrMjwalJSd10lCEghrKBodsKEL/gmgJQhqCFkdBIxBEFFGc/IoaoyTQWQORFq2Mc8AXNcnHF9936gZBfY7nd851rvso6na7XfznI/qF/kvFf+UdULfdbuPh4QGrq6sQi8V/nn1+foKeSaVSfgk9Y+UtFovY3d2FXC7H29sbyuUyZDIZ508kEtjc3EQ8HofJZBLKxI/Qer2O9fV1pNNpXFxc4PT0FI+Pj1heXgZ16fP5cHl5CYqbm5sbCaU1IBKJBp79CCUIyXlycgKtVotqtYpGowGJRMJQnU7Hye7v7wdk7xHC4TBarRYr1T+WH6HU1ezsLP+Qutve3kYoFOLKn5+fsbS0NPBdfztUlNVqhUajQTAY5EJ7Z+xMSZ7z83McHx8jEonA6XTyb6PRKFwuF66vr7G3tzdSWjIZwfqBFDgWShWbzWbkcjm8v79zAirk8PCQO6hUKpiZmWH5FhYWGE5xsVgMKpUKer3+76GULJPJcHJKajAY0Gw28fLywgWQe7e2tvDx8YGdnR04HA643W48PT1hcXFRuJEokjrd2NhgExUKBa6aJPV6vVhbW0MymYTRaEQqlcL8/Dz8fj/LTW6mz6VSie93/xkrLwUTzGKxYGVlhaVUq9X8PhAIcId2ux37+/tcUKfTYTWy2SzP//X19ZuzBUFphiQbJVIqlexIAtD1IYcTeHgjHRwcoFar4fb2drJ7KnjFDAX27jDN9ujo6FsaQZ1OCicFFAoF7u7u2L3DZ6pQGgEtjpubG3g8npHzFHRPhXZJsyXXXl1d4ezsjDcZ7evhxTBVaD6fZ0PZbDZ2N/0R9O/bia+MkG7JPHRIYoKN6lDw7hUCnDRmqkYSCv8CPqRuxbMM1akAAAAASUVORK5CYII=)作为softmax函数的输入，得到![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAgCAYAAADjaQM7AAAC00lEQVRIS+2VPUhycRTGHy1LaChsiCCIsFVKMhzLij6mHIRWBcdCEKvJpaEh6UPQJYJoi9qClj4kCgStIQVxjkQy7EMkSvvw5RxIvOa9Xila3i78F7me55zf85z/VRQKhQJ+6VH8if0E6f8Y49vbGyiwSqUSdXV1RZofHx+gU19fL5uwJMZwOAyn04lEIoGxsTH4/f5i8e3tbXi9XhwdHaGpqUmWoKjY3d0dJicnsbOzw0WXlpaQz+ehUql4UrPZjL29PdDkpRNLqYqKra+v4+HhAbOzs9Dr9bi6usLNzQ3UajXj02g06OnpwcnJCRQKRVEjFAohFovBarUy+tJHVCwej6O5uRnPz8/o7u7GzMwM1tbWuMDFxQX6+/vhdruxsLAg8HF8fBxarRY+n+/LxJKeEa6VlRW4XC4W6Ovr48Iejwdzc3Ps1/DwsKD7l5cXFiHc5Y+kGOEymUyIRCJIp9McDvptcHAQZ2dneH19LQaGvNvf30d7ezs3VclHSTEqQAg7OzsRCAS4QC6XQ1tbm8Cv9/d3npZ8XFxcxO7uLmOuaTLq3GAwcADOz885heTb/Py8wC9aCWqKkBK+w8NDjIyM1CZGyMir0dFRDAwMMMrr62s+pX7RStDUl5eX3BxNWp5EUpbEmM1m0djYyB2Sbx0dHZiamkI0GsXt7S0aGhoE3S8vL/Pula/D50uiYoSwt7cXyWSS94tEDw4O+CahHbTb7YL9+gwTEShdB1l7RmhIYGJigm+Rp6cnFtLpdNjc3PxyJ1KYyK/j42MMDQ1VvEhEJ6M/T09PIxgMoqWlBY+Pj3A4HLDZbAI/KJ0UoNPTU1gsFtzf31f0q6pnJEh4MpkMWltbvxQh34xGI7a2trCxscFNra6uit6V3/p4plIpFqPT1dXFO1YphVUDIuubAfDkdEhESqgqRrmCct/7Fka5Ij+GsRbBv8lqoSX67h/GH8H4D8V6t7C6HY7rAAAAAElFTkSuQmCC)：

![img](data:image/jpeg;base64,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)

##3.fasttext为什么快？

为了改进效率，fasttext做了三件事情：

1.算n-gram的时候，用了hash桶的方式，把所有的n-gram的embedding映射到bucket个桶中，hash到同一个桶中的所有n-gram共享一个embedding vector。如下图。

![wordembeddings](https://cl.ly/2M2F2g3G0W1d/wordembedding.png)

2.预计算，比如sigmoid函数计算非常耗时，fasttext就提前把值算好，到时候直接查表。代码如下：

```C++
void initSigmoid() {
    t_sigmoid = new real[SIGMOID_TABLE_SIZE + 1];
    for (int i = 0; i < SIGMOID_TABLE_SIZE + 1; i++) {
        real x = real(i * 2 * MAX_SIGMOID) / SIGMOID_TABLE_SIZE - MAX_SIGMOID;
        t_sigmoid[i] = 1.0 / (1.0 + std::exp(-x));
    }
}
```



3.在negative sampling的时候采用每个词的词频进行随机负采样的方式。

在Negative Sampling中，Fasttext也采用了和word2vec类似的方法，即按照每个词的词频进行随机负采样，词频越大的词，被采样的概率越大。每个词被采样的概率并不是简单的按照词频在总量的占比，而是对词频先取根号，再算占比，即pw=f1/2w∑jf1/2jpw=fw1/2∑jfj1/2。其中fw表示词w的词频。这里取根号的目的是降低高频词的采用概率，同时增加低频词的采样概率，具体代码如下：

```c++
void Model::initTableNegatives(const std::vector<int64_t>& counts) {
    real z = 0.0;
    for (size_t i = 0; i < counts.size(); i++) {
    z += pow(counts[i], 0.5);
    }
    for (size_t i = 0; i < counts.size(); i++) {
        real c = pow(counts[i], 0.5);
        for (size_t j = 0; j < c * NEGATIVE_TABLE_SIZE / z; j++) {
            negatives.push_back(i);
        }
    }
    std::shuffle(negatives.begin(), negatives.end(), rng);
}
```

